<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Quiet Light of Ember's Landing</title>
    <style>
        body {
            font-family: 'Arial', 'Microsoft YaHei', sans-serif; /* Added Chinese font */
            background-color: #f0f0f0;
            color: #333;
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            cursor: pointer; 
        }

        .book-container {
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            padding: 2rem;
            width: 90%;
            max-width: 700px;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative; /* For the button */
        }
        
        #lang-toggle {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: #007bff;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            z-index: 10;
        }

        #book-image {
            width: 100%;
            max-width: 400px;
            height: auto;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin-bottom: 1.5rem;
        }

        #book-content {
            text-align: left;
            margin-top: 1rem;
            white-space: pre-wrap;
            line-height: 1.8;
            font-size: 1.1em;
            overflow-y: auto;
            max-height: 50vh;
            padding-right: 15px;
        }

        h1, h2, p {
            margin: 0.5rem 0;
        }

        #title, #author {
            color: #222;
        }
        
        #page-number {
            font-weight: bold;
            color: #666;
            margin-top: 1rem;
        }
        
        /* --- NEW CSS for Vocab Link --- */
        #vocab-link-container {
            margin-top: 2rem;
            padding-top: 1rem;
            border-top: 1px dashed #ccc;
            width: 100%;
            text-align: center;
            display: none; /* Initially hidden, controlled by JS */
        }

        #vocab-link {
            display: inline-block;
            background-color: #28a745; /* Green color */
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            text-decoration: none;
            font-weight: bold;
            transition: background-color 0.3s;
        }

        #vocab-link:hover {
            background-color: #1e7e34;
        }

        #vocab-description {
            display: block;
            font-size: 0.9em;
            color: #666;
            margin-top: 5px;
        }

    </style>
</head>
<body>
    <div class="book-container">
        <button id="lang-toggle">Chinese</button>
        <h1 id="title"></h1>
        <h2 id="author"></h2>
        <img id="book-image" src="" alt="Book Image">
        <p id="book-content"></p>
        <p id="page-number"></p>

        <div id="vocab-link-container">
            <a id="vocab-link" href="vocab.html">View Vocabulary List</a>
            <span id="vocab-description">Explore vocabulary words from this story</span>
        </div>
        </div>

    <script>
        const ALL_BOOK_DATA = {
  "en": {
    "1": "The old harbor town of Ember's Landing was usually a place of boisterous chatter and the sharp, salty tang of the sea. But this morning, a pall had settled over it.",
    "2": "Elias, a man whose life had been spent on the waves, sat on his usual bench, his gaze fixed on the horizon. He wasn't looking at the sea; he was looking through it.",
    "3": "A young woman named Clara approached him, her steps measured, her hands clutched around a mug of tea. She had lost her father, Elias's lifelong friend, just three weeks prior. The town, in its clumsy way, had offered sympathies that felt hollow and perfunctory.",
    "4": "\"It's a bitter day, isn't it, Elias?\" she said, offering him the mug. He took it, the warmth a small solace. \"The sea doesn't care about our calendars, Clara. It just is.\"",
    "5": "She sat beside him, their silence more eloquent than any rushed attempt at conversation. This was the advanced English: not a strange word, but the gravitas of the pause, the subtlety of understanding.",
    "6": "\"I keep expecting to see his boat creeping in just past the lighthouse,\" she confessed, her voice barely a whisper. \"It’s a fool's hope, I know, but I can't seem to dislodge it.\" Elias turned to her, his weathered face softening.",
    "7": "\"Hope isn't meant to be dislodged, child. It's meant to be recast.\" He gestured toward the distant, shimmering water. \"Your father taught me that every fisherman has two jobs: catching fish and telling stories. The boat... that was just the vessel. The real work was always the stories he brought back. The joy, the danger, the sheer absurdity of life out there.\"",
    "8": "Clara finally smiled, a genuine, unburdened lifting of her mouth. \"He used to say a good lie was just a true story that hasn't happened yet.\" \"That's the spirit,\" Elias chuckled, a dry, raspy sound.",
    "9": "\"Your grief, Clara, is simply the underside of your love. It feels monumental now, a stone you can't push. But you don't need to push it. You just need to walk around it and remember what it was built to honor.\" He sipped the tea, its warmth now reaching his soul. \"He wouldn't want you mired here. Take the stories he gave you and build your own. That's how we keep them afloat.\"",
    "10": "The pall over Ember's Landing hadn't lifted, but a small, quiet light had been lit inside Clara. She looked at the sea not as the enemy that took her father, but as the endless, untamed backdrop to a life well-lived.",
    "title": "The Quiet Light of Ember's Landing",
    "author": "By AI"
  },
  "zh": {
    "1": "埃姆伯登陆港这个古老的港口小镇，通常充满了喧闹的谈笑声和海水的咸腥味。但今天早上，一片阴霾笼罩了它。",
    "2": "埃利亚斯，一个将毕生献给大海的男人，坐在他常坐的长凳上，目光凝视着地平线。他看的不是海，而是透过海。",
    "3": "一个名叫克拉拉的年轻女子走到他身边，她的脚步沉稳，双手紧紧捧着一杯茶。就在三周前，她失去了她的父亲——埃利亚斯一生的挚友。镇上的人们笨拙地表达了同情，那些同情听起来空洞而敷衍。",
    "4": "“今天是苦涩的一天，不是吗，埃利亚斯？” 她说，将茶杯递给他。他接了过来，那份温暖是小小的慰藉。“大海才不在乎我们的日历，克拉拉。它只是存在。”",
    "5": "她在他身边坐下，他们的沉默比任何仓促的交谈都更有力量。这就是高级的英语（Advanced English）：不是那些奇怪的词汇，而是停顿的庄重感，是理解的微妙之处。",
    "6": "“我总期待着能看到他的船从灯塔后面缓缓驶入，”她坦白，声音几乎是耳语。“我知道这是痴心妄想，但我似乎就是无法驱散这个念头。”埃利亚斯转向她，他饱经风霜的脸庞柔和了下来。",
    "7": "“希望不是用来驱散的，孩子。它是用来重塑的。”他指向远处那片闪烁的水面。“你父亲教导我，每个渔夫都有两份工作：捕鱼和讲故事。船……那只是个载体。真正的工作永远是他带回来的那些故事。那些欢乐、危险，以及海上生活的纯粹荒谬。”",
    "8": "克拉拉终于笑了，那是真诚的、毫无负担的嘴角上扬。“他常说，一个好的谎言，不过是一个尚未发生的真实故事。”“这才对嘛，”埃利亚斯笑了，发出沙哑而干涩的笑声。",
    "9": "“你的悲伤，克拉拉，不过是你爱意的另一面。它现在感觉像一座巨大的、推不动的石头。但你不需要推它。你只需要绕着它走，并记住它建立起来是为了纪念什么。”他呷了一口茶，那份温暖现在抵达了他的灵魂。“他不会希望你沉溺于此。带着他给你的故事，去创造你自己的故事。我们就是这样让他们不被遗忘的。”",
    "10": "笼罩在埃姆伯登陆港上空的阴霾尚未散去，但克拉拉心中却点亮了一盏微小而宁静的光。她望着大海，不再将它视为夺走她父亲的敌人，而是将它视为一段精彩人生的无尽、不羁的背景。",
    "title": "艾姆伯斯角港的微光",
    "author": "作者 人工智能"
  }
};
        
const synth = window.speechSynthesis;
    
    // *** Scope Fix: These variables are now in the script's outer scope ***
    let currentLang = 'en'; // Default language is English
    let currentPage = -1; // -1 for cover
    
    // Mapping language codes to speech voices
    const VOICE_MAP = {
        'en': 'en-US',
        'zh': 'zh-CN' 
    };
    
    function getBookData() {
        return ALL_BOOK_DATA[currentLang];
    }

    // --- Speech Functions (No change needed) ---
    function speakContent(text) {
        if (!synth) {
            console.warn("Speech synthesis not supported.");
            return;
        }
        
        if (synth.speaking) {
            synth.cancel();
        }

        const utterance = new SpeechSynthesisUtterance(text);
        
        const voiceCode = VOICE_MAP[currentLang];
        const voices = synth.getVoices();
        const selectedVoice = voices.find(voice => voice.lang === voiceCode) || null;
        
        if (selectedVoice) {
            utterance.voice = selectedVoice;
        } else {
            utterance.lang = voiceCode;
        }

        synth.speak(utterance);
    }
    
    function stopSpeaking() {
        if (synth && synth.speaking) {
            synth.cancel();
        }
    }
    
    // --- Vocabulary Link Logic (Simplified and added here) ---
    function updateVocabLinkVisibility(totalTextPages) {
        const vocabContainer = document.getElementById('vocab-link-container');
        // The link should show on the End Page, which is currentPage === totalTextPages
        const isEndPage = currentPage === totalTextPages; 
        
        if (vocabContainer) {
            vocabContainer.style.display = isEndPage ? 'block' : 'none';
        }
    }
    
    function updateVocabLinkLanguage() {
        const vocabLink = document.getElementById('vocab-link');
        const vocabDescription = document.getElementById('vocab-description');
        
        if (currentLang === 'zh') {
            vocabLink.textContent = '查看词汇表';
            vocabDescription.textContent = '探索本故事中的词汇';
        } else {
            vocabLink.textContent = 'View Vocabulary List';
            vocabDescription.textContent = 'Explore vocabulary words from this story';
        }
    }

    // --- Function to toggle language (Now in the outer scope) ---
    function toggleLanguage() {
        const langToggleButton = document.getElementById('lang-toggle');
        currentLang = currentLang === 'en' ? 'zh' : 'en';
        
        if (currentLang === 'zh') {
            langToggleButton.textContent = '英文 English';
        } else {
            langToggleButton.textContent = 'Chinese 中文';
        }
        
        // --- Core Change: Call the language-specific vocab link update ---
        updateVocabLinkLanguage();

        updateUI();
    }
    
    // --- Main UI Update Function (Now in the outer scope) ---
    function updateUI() {
        const bookData = getBookData();
        const bookKeys = Object.keys(bookData);
        const totalTextPages = bookKeys.filter(key => !isNaN(parseInt(key))).length;
        
        if (currentPage > totalTextPages) {
            currentPage = totalTextPages;
        }

        const isCoverPage = currentPage === -1;
        const isEndPage = currentPage === totalTextPages;

        const titleElement = document.getElementById('title');
        const authorElement = document.getElementById('author');
        const imageElement = document.getElementById('book-image');
        const contentElement = document.getElementById('book-content');
        const pageNumberElement = document.getElementById('page-number');

        let imagePath, content, pageText;

        // --- 1. Determine Content and Metadata ---
        if (isCoverPage) {
            // Check for explicit cover path, otherwise use default
            imagePath = `images/${bookData.cover || 'cover.png'}`; 
            content = bookData.cover_text || '';
            pageText = '';
        } else if (isEndPage) {
            // Use explicit end image if available, otherwise use default
            imagePath = `images/${bookData.end_image || 'end.png'}`; 
            content = bookData.end || '';
            pageText = currentLang === 'en' ? 'End Page' : '结束页';
        } else {
            const pageKey = (currentPage + 1).toString();
            imagePath = `images/${pageKey}.png`;
            content = bookData[pageKey] || '';
            pageText = `${currentLang === 'en' ? 'Page' : '页'} ${pageKey} ${currentLang === 'en' ? 'of' : '共'} ${totalTextPages}`;
        }
        
        // --- 2. Update DOM Elements ---
        titleElement.style.display = isCoverPage ? 'block' : 'none';
        authorElement.style.display = isCoverPage ? 'block' : 'none';

        titleElement.textContent = bookData.title;
        authorElement.textContent = bookData.author;
        imageElement.src = imagePath;
        contentElement.textContent = content;
        pageNumberElement.textContent = pageText;
        
        // --- Core Change: Call the visibility vocab link update ---
        updateVocabLinkVisibility(totalTextPages);
        
        // --- 3. Speech Logic ---
        let speechText;
        if (isCoverPage) {
            speechText = `${bookData.title}. By ${bookData.author}. ${content}`;
        } else {
            speechText = content;
        }
        
        stopSpeaking();
        speakContent(speechText);
    }

    function changePage(direction) {
        const bookData = getBookData();
        const totalTextPages = Object.keys(bookData).filter(key => !isNaN(parseInt(key))).length;
        let newPage = currentPage + direction;

        // Looping Logic (End Page to Cover Page)
        if (direction === 1) { 
            if (newPage > totalTextPages) {
                newPage = -1; 
            }
        } else if (direction === -1) { 
            if (newPage < -1) {
                return;
            }
        }
        
        if (newPage >= -1 && newPage <= totalTextPages) {
            currentPage = newPage;
            updateUI();
        }
    }

    // --- Navigation/Initial Setup Event Handlers ---
    document.addEventListener('DOMContentLoaded', () => {
        const langToggleButton = document.getElementById('lang-toggle');
        
        // Set initial button state (English mode, button says "Chinese")
        langToggleButton.textContent = 'Chinese 中文'; 

        langToggleButton.addEventListener('click', (event) => {
            event.stopPropagation();
            toggleLanguage();
        });
        
        document.body.addEventListener('click', (event) => {
            // Check if click target is the language toggle or inside the vocab link container
            if (event.target.id === 'lang-toggle' || event.target.closest('#vocab-link-container')) return;

            const isRightSide = event.clientX > window.innerWidth / 2;
            if (isRightSide) {
                changePage(1);
            } else {
                if (currentPage > -1) {
                    changePage(-1);
                }
            }
        });

        document.body.addEventListener('keyup', (event) => {
            const isNextKey = event.key === 'Enter' || event.keyCode === 13 || event.key === 'ArrowRight' || event.keyCode === 39;
            const isPreviousKey = event.key === 'ArrowLeft' || event.keyCode === 37;

            if (isNextKey) {
                changePage(1);
            } else if (isPreviousKey) {
                if (currentPage > -1) {
                    changePage(-1);
                }
            }
        });
        
        // --- Initial setup calls ---
        updateUI(); 
        updateVocabLinkLanguage(); // Call this once to set initial language on the link
    });

</script>
</body>
</html>