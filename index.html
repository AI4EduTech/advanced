<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Quiet Light of Ember's Landing</title>
    <style>
        body {
            font-family: 'Arial', 'Microsoft YaHei', sans-serif;
            background-color: #f0f0f0;
            color: #333;
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            cursor: pointer; 
        }

        .book-container {
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            padding: 2rem;
            width: 90%;
            max-width: 700px;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
        }
        
        #lang-toggle {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: #007bff;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            z-index: 10;
        }

        #book-image {
            width: 100%;
            max-width: 400px;
            height: auto;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin-bottom: 1.5rem;
        }

        #book-content {
            text-align: left;
            margin-top: 1rem;
            white-space: pre-wrap;
            line-height: 1.8;
            font-size: 1.1em;
            overflow-y: auto;
            max-height: 50vh;
            padding-right: 15px;
        }

        h1, h2, p {
            margin: 0.5rem 0;
        }

        #title, #author {
            color: #222;
        }
        
        #page-number {
            font-weight: bold;
            color: #666;
            margin-top: 1rem;
        }

        /* --- Download Links Container --- */
        .downloads-container {
            margin-top: 2rem;
            padding-top: 1rem;
            border-top: 1px dashed #ccc;
            width: 100%;
            text-align: center;
            display: none; /* Initially hidden */
        }

        .download-section {
            margin-bottom: 1.5rem;
        }

        .download-section h3 {
            margin-bottom: 1rem;
            color: #333;
            font-size: 1.2em;
        }

        .download-links {
            display: flex;
            justify-content: center;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .download-link {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            background-color: #6c757d;
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            text-decoration: none;
            font-weight: bold;
            transition: background-color 0.3s;
            min-width: 180px;
            justify-content: center;
        }

        .download-link:hover {
            background-color: #545b62;
        }

        .download-link.english {
            background-color: #007bff;
        }

        .download-link.english:hover {
            background-color: #0056b3;
        }

        .download-link.chinese {
            background-color: #dc3545;
        }

        .download-link.chinese:hover {
            background-color: #c82333;
        }

        .download-icon {
            font-size: 1.2em;
        }

        .file-size {
            font-size: 0.8em;
            opacity: 0.8;
            margin-left: 0.5rem;
        }

        .no-audio-message {
            color: #666;
            font-style: italic;
            margin-top: 1rem;
        }
    </style>
</head>
<body>
    <div class="book-container">
        <button id="lang-toggle">Chinese</button>
        <h1 id="title"></h1>
        <h2 id="author"></h2>
        <img id="book-image" src="" alt="Book Image">
        <p id="book-content"></p>
        <p id="page-number"></p>
        
        <!-- Vocabulary Link Container -->
        <div id="vocab-link-container">
            <a id="vocab-link" href="vocab.html">View Vocabulary List</a>
            <span id="vocab-description">Explore vocabulary words from this story</span>
        </div>

        <!-- MP3 Download Links Container -->
        <div id="downloads-container" class="downloads-container">
            <div class="download-section">
                <h3 id="download-title">Download Audio Book</h3>
                <div class="download-links">
                    <a href="book.en.mp3" class="download-link english" download>
                        <span class="download-icon">ðŸŽµ</span>
                        <span id="english-download-text">English MP3</span>
                        <span class="file-size" id="english-file-size"></span>
                    </a>
                    <a href="book.zh.mp3" class="download-link chinese" download>
                        <span class="download-icon">ðŸŽµ</span>
                        <span id="chinese-download-text">ä¸­æ–‡ MP3</span>
                        <span class="file-size" id="chinese-file-size"></span>
                    </a>
                </div>
                <p id="no-audio-message" class="no-audio-message" style="display: none;">
                    
                </p>
            </div>
        </div>
    </div>

    <script>
        const ALL_BOOK_DATA = {
            "en": {
                "title": "The Quiet Light of Ember's Landing",
                "author": "By AI",
                "1": "The old harbor town of Ember's Landing was usually a place of boisterous chatter and the sharp, salty tang of the sea. But this morning, a pall had settled over it.",
                "2": "Elias, a man whose life had been spent on the waves, sat on his usual bench, his gaze fixed on the horizon. He wasn't looking at the sea; he was looking through it.",
                "3": "A young woman named Clara approached him, her steps measured, her hands clutched around a mug of tea. She had lost her father, Elias's lifelong friend, just three weeks prior. The town, in its clumsy way, had offered sympathies that felt hollow and perfunctory.",
                "4": "\"It's a bitter day, isn't it, Elias?\" she said, offering him the mug. He took it, the warmth a small solace. \"The sea doesn't care about our calendars, Clara. It just is.\"",
                "5": "She sat beside him, their silence more eloquent than any rushed attempt at conversation. This was the advanced English: not a strange word, but the gravitas of the pause, the subtlety of understanding.",
                "6": "\"I keep expecting to see his boat creeping in just past the lighthouse,\" she confessed, her voice barely a whisper. \"It's a fool's hope, I know, but I can't seem to dislodge it.\" Elias turned to her, his weathered face softening.",
                "7": "\"Hope isn't meant to be dislodged, child. It's meant to be recast.\" He gestured toward the distant, shimmering water. \"Your father taught me that every fisherman has two jobs: catching fish and telling stories. The boat... that was just the vessel. The real work was always the stories he brought back. The joy, the danger, the sheer absurdity of life out there.\"",
                "8": "Clara finally smiled, a genuine, unburdened lifting of her mouth. \"He used to say a good lie was just a true story that hasn't happened yet.\" \"That's the spirit,\" Elias chuckled, a dry, raspy sound.",
                "9": "\"Your grief, Clara, is simply the underside of your love. It feels monumental now, a stone you can't push. But you don't need to push it. You just need to walk around it and remember what it was built to honor.\" He sipped the tea, its warmth now reaching his soul. \"He wouldn't want you mired here. Take the stories he gave you and build your own. That's how we keep them afloat.\"",
                "10": "The pall over Ember's Landing hadn't lifted, but a small, quiet light had been lit inside Clara. She looked at the sea not as the enemy that took her father, but as the endless, untamed backdrop to a life well-lived."
            },
            "zh": {
                "title": "è‰¾å§†ä¼¯æ–¯è§’æ¸¯çš„å¾®å…‰",
                "author": "ä½œè€… äººå·¥æ™ºèƒ½",
                "1": "åŸƒå§†ä¼¯ç™»é™†æ¸¯è¿™ä¸ªå¤è€çš„æ¸¯å£å°é•‡ï¼Œé€šå¸¸å……æ»¡äº†å–§é—¹çš„è°ˆç¬‘å£°å’Œæµ·æ°´çš„å’¸è…¥å‘³ã€‚ä½†ä»Šå¤©æ—©ä¸Šï¼Œä¸€ç‰‡é˜´éœ¾ç¬¼ç½©äº†å®ƒã€‚",
                "2": "åŸƒåˆ©äºšæ–¯ï¼Œä¸€ä¸ªå°†æ¯•ç”ŸçŒ®ç»™å¤§æµ·çš„ç”·äººï¼Œååœ¨ä»–å¸¸åçš„é•¿å‡³ä¸Šï¼Œç›®å…‰å‡è§†ç€åœ°å¹³çº¿ã€‚ä»–çœ‹çš„ä¸æ˜¯æµ·ï¼Œè€Œæ˜¯é€è¿‡æµ·ã€‚",
                "3": "ä¸€ä¸ªåå«å…‹æ‹‰æ‹‰çš„å¹´è½»å¥³å­èµ°åˆ°ä»–èº«è¾¹ï¼Œå¥¹çš„è„šæ­¥æ²‰ç¨³ï¼ŒåŒæ‰‹ç´§ç´§æ§ç€ä¸€æ¯èŒ¶ã€‚å°±åœ¨ä¸‰å‘¨å‰ï¼Œå¥¹å¤±åŽ»äº†å¥¹çš„çˆ¶äº²â€”â€”åŸƒåˆ©äºšæ–¯ä¸€ç”Ÿçš„æŒšå‹ã€‚é•‡ä¸Šçš„äººä»¬ç¬¨æ‹™åœ°è¡¨è¾¾äº†åŒæƒ…ï¼Œé‚£äº›åŒæƒ…å¬èµ·æ¥ç©ºæ´žè€Œæ•·è¡ã€‚",
                "4": "ã€Œä»Šå¤©æ˜¯è‹¦æ¶©çš„ä¸€å¤©ï¼Œä¸æ˜¯å—ï¼ŒåŸƒåˆ©äºšæ–¯ï¼Ÿã€ å¥¹è¯´ï¼Œå°†èŒ¶æ¯é€’ç»™ä»–ã€‚ä»–æŽ¥äº†è¿‡æ¥ï¼Œé‚£ä»½æ¸©æš–æ˜¯å°å°çš„æ…°è—‰ã€‚ã€Œå¤§æµ·æ‰ä¸åœ¨ä¹Žæˆ‘ä»¬çš„æ—¥åŽ†ï¼Œå…‹æ‹‰æ‹‰ã€‚å®ƒåªæ˜¯å­˜åœ¨ã€‚ã€",
                "5": "å¥¹åœ¨ä»–èº«è¾¹åä¸‹ï¼Œä»–ä»¬çš„æ²‰é»˜æ¯”ä»»ä½•ä»“ä¿ƒçš„äº¤è°ˆéƒ½æ›´æœ‰åŠ›é‡ã€‚è¿™å°±æ˜¯é«˜çº§çš„è‹±è¯­ï¼ˆAdvanced Englishï¼‰ï¼šä¸æ˜¯é‚£äº›å¥‡æ€ªçš„è¯æ±‡ï¼Œè€Œæ˜¯åœé¡¿çš„åº„é‡æ„Ÿï¼Œæ˜¯ç†è§£çš„å¾®å¦™ä¹‹å¤„ã€‚",
                "6": "ã€Œæˆ‘æ€»æœŸå¾…ç€èƒ½çœ‹åˆ°ä»–çš„èˆ¹ä»Žç¯å¡”åŽé¢ç¼“ç¼“é©¶å…¥ï¼Œã€å¥¹å¦ç™½ï¼Œå£°éŸ³å‡ ä¹Žæ˜¯è€³è¯­ã€‚ã€Œæˆ‘çŸ¥é“è¿™æ˜¯ç—´å¿ƒå¦„æƒ³ï¼Œä½†æˆ‘ä¼¼ä¹Žå°±æ˜¯æ— æ³•é©±æ•£è¿™ä¸ªå¿µå¤´ã€‚ã€åŸƒåˆ©äºšæ–¯è½¬å‘å¥¹ï¼Œä»–é¥±ç»é£Žéœœçš„è„¸åºžæŸ”å’Œäº†ä¸‹æ¥ã€‚",
                "7": "ã€Œå¸Œæœ›ä¸æ˜¯ç”¨æ¥é©±æ•£çš„ï¼Œå­©å­ã€‚å®ƒæ˜¯ç”¨æ¥é‡å¡‘çš„ã€‚ã€ä»–æŒ‡å‘è¿œå¤„é‚£ç‰‡é—ªçƒçš„æ°´é¢ã€‚ã€Œä½ çˆ¶äº²æ•™å¯¼æˆ‘ï¼Œæ¯ä¸ªæ¸”å¤«éƒ½æœ‰ä¸¤ä»½å·¥ä½œï¼šæ•é±¼å’Œè®²æ•…äº‹ã€‚èˆ¹â€¦â€¦é‚£åªæ˜¯ä¸ªè½½ä½“ã€‚çœŸæ­£çš„å·¥ä½œæ°¸è¿œæ˜¯ä»–å¸¦å›žæ¥çš„é‚£äº›æ•…äº‹ã€‚é‚£äº›æ¬¢ä¹ã€å±é™©ï¼Œä»¥åŠæµ·ä¸Šç”Ÿæ´»çš„çº¯ç²¹è’è°¬ã€‚ã€",
                "8": "å…‹æ‹‰æ‹‰ç»ˆäºŽç¬‘äº†ï¼Œé‚£æ˜¯çœŸè¯šçš„ã€æ¯«æ— è´Ÿæ‹…çš„å˜´è§’ä¸Šæ‰¬ã€‚ã€Œä»–å¸¸è¯´ï¼Œä¸€ä¸ªå¥½çš„è°Žè¨€ï¼Œä¸è¿‡æ˜¯ä¸€ä¸ªå°šæœªå‘ç”Ÿçš„çœŸå®žæ•…äº‹ã€‚ã€ã€Œè¿™æ‰å¯¹å˜›ï¼Œã€åŸƒåˆ©äºšæ–¯ç¬‘äº†ï¼Œå‘å‡ºæ²™å“‘è€Œå¹²æ¶©çš„ç¬‘å£°ã€‚",
                "9": "ã€Œä½ çš„æ‚²ä¼¤ï¼Œå…‹æ‹‰æ‹‰ï¼Œä¸è¿‡æ˜¯ä½ çˆ±æ„çš„å¦ä¸€é¢ã€‚å®ƒçŽ°åœ¨æ„Ÿè§‰åƒä¸€åº§å·¨å¤§çš„ã€æŽ¨ä¸åŠ¨çš„çŸ³å¤´ã€‚ä½†ä½ ä¸éœ€è¦æŽ¨å®ƒã€‚ä½ åªéœ€è¦ç»•ç€å®ƒèµ°ï¼Œå¹¶è®°ä½å®ƒå»ºç«‹èµ·æ¥æ˜¯ä¸ºäº†çºªå¿µä»€ä¹ˆã€‚ã€ä»–å‘·äº†ä¸€å£èŒ¶ï¼Œé‚£ä»½æ¸©æš–çŽ°åœ¨æŠµè¾¾äº†ä»–çš„çµé­‚ã€‚ã€Œä»–ä¸ä¼šå¸Œæœ›ä½ æ²‰æººäºŽæ­¤ã€‚å¸¦ç€ä»–ç»™ä½ çš„æ•…äº‹ï¼ŒåŽ»åˆ›é€ ä½ è‡ªå·±çš„æ•…äº‹ã€‚æˆ‘ä»¬å°±æ˜¯è¿™æ ·è®©ä»–ä»¬ä¸è¢«é—å¿˜çš„ã€‚ã€",
                "10": "ç¬¼ç½©åœ¨åŸƒå§†ä¼¯ç™»é™†æ¸¯ä¸Šç©ºçš„é˜´éœ¾å°šæœªæ•£åŽ»ï¼Œä½†å…‹æ‹‰æ‹‰å¿ƒä¸­å´ç‚¹äº®äº†ä¸€ç›å¾®å°è€Œå®é™çš„å…‰ã€‚å¥¹æœ›ç€å¤§æµ·ï¼Œä¸å†å°†å®ƒè§†ä¸ºå¤ºèµ°å¥¹çˆ¶äº²çš„æ•Œäººï¼Œè€Œæ˜¯å°†å®ƒè§†ä¸ºä¸€æ®µç²¾å½©äººç”Ÿçš„æ— å°½ã€ä¸ç¾çš„èƒŒæ™¯ã€‚"
            }
        };

        const synth = window.speechSynthesis;
        let currentLang = 'en';
        let currentPage = -1;
        
        const VOICE_MAP = {
            'en': 'en-US',
            'zh': 'zh-CN' 
        };

        function getBookData() {
            return ALL_BOOK_DATA[currentLang];
        }

        // --- Audio File Checking and Size Functions ---
        async function checkAudioFiles() {
            const files = [
                { url: 'book.en.mp3', lang: 'en', element: 'english-file-size' },
                { url: 'book.zh.mp3', lang: 'zh', element: 'chinese-file-size' }
            ];

            let anyFileExists = false;

            for (const file of files) {
                try {
                    const response = await fetch(file.url, { method: 'HEAD' });
                    if (response.ok) {
                        const size = response.headers.get('content-length');
                        const sizeMB = size ? (size / (1024 * 1024)).toFixed(1) + ' MB' : '';
                        document.getElementById(file.element).textContent = sizeMB;
                        anyFileExists = true;
                    } else {
                        document.getElementById(file.element).textContent = '';
                    }
                } catch (error) {
                    document.getElementById(file.element).textContent = '';
                }
            }

            // Show/hide download section and no-audio message
            const downloadsContainer = document.getElementById('downloads-container');
            const noAudioMessage = document.getElementById('no-audio-message');
            
            if (anyFileExists) {
                downloadsContainer.style.display = 'block';
                noAudioMessage.style.display = 'none';
            } else {
                downloadsContainer.style.display = 'block';
                noAudioMessage.style.display = 'block';
            }
        }

        // --- Download Section Language Update ---
        function updateDownloadSectionLanguage() {
            const downloadTitle = document.getElementById('download-title');
            const englishDownloadText = document.getElementById('english-download-text');
            const chineseDownloadText = document.getElementById('chinese-download-text');
            const noAudioMessage = document.getElementById('no-audio-message');

            if (currentLang === 'zh') {
                downloadTitle.textContent = 'ä¸‹è½½æœ‰å£°ä¹¦';
                englishDownloadText.textContent = 'è‹±æ–‡ MP3';
                chineseDownloadText.textContent = 'ä¸­æ–‡ MP3';
                noAudioMessage.textContent = 'éŸ³é¢‘æ–‡ä»¶ä¸å¯ç”¨ã€‚è¯·è¿è¡ŒPythonè„šæœ¬æ¥ç”Ÿæˆå®ƒä»¬ã€‚';
            } else {
                downloadTitle.textContent = 'Download Audio Book';
                englishDownloadText.textContent = 'English MP3';
                chineseDownloadText.textContent = 'Chinese MP3';
                noAudioMessage.textContent = 'Audio files not available. Run the Python script to generate them.';
            }
        }

        // --- Speech Functions ---
        function speakContent(text) {
            if (!synth) return;
            
            if (synth.speaking) {
                synth.cancel();
            }

            const utterance = new SpeechSynthesisUtterance(text);
            const voiceCode = VOICE_MAP[currentLang];
            const voices = synth.getVoices();
            const selectedVoice = voices.find(voice => voice.lang === voiceCode) || null;
            
            if (selectedVoice) {
                utterance.voice = selectedVoice;
            } else {
                utterance.lang = voiceCode;
            }

            synth.speak(utterance);
        }
        
        function stopSpeaking() {
            if (synth && synth.speaking) {
                synth.cancel();
            }
        }

        // --- Vocabulary Link Logic ---
        function updateVocabLinkVisibility(totalTextPages) {
            const vocabContainer = document.getElementById('vocab-link-container');
            const isEndPage = currentPage === totalTextPages; 
            
            if (vocabContainer) {
                vocabContainer.style.display = isEndPage ? 'block' : 'none';
            }
        }
        
        function updateVocabLinkLanguage() {
            const vocabLink = document.getElementById('vocab-link');
            const vocabDescription = document.getElementById('vocab-description');
            
            if (!vocabLink || !vocabDescription) return;
            
            if (currentLang === 'zh') {
                vocabLink.textContent = 'æŸ¥çœ‹è¯æ±‡è¡¨';
                vocabDescription.textContent = 'æŽ¢ç´¢æœ¬æ•…äº‹ä¸­çš„è¯æ±‡';
            } else {
                vocabLink.textContent = 'View Vocabulary List';
                vocabDescription.textContent = 'Explore vocabulary words from this story';
            }
        }

        // --- Language Toggle ---
        function toggleLanguage() {
            const langToggleButton = document.getElementById('lang-toggle');
            currentLang = currentLang === 'en' ? 'zh' : 'en';
            
            if (currentLang === 'zh') {
                langToggleButton.textContent = 'è‹±æ–‡ English';
            } else {
                langToggleButton.textContent = 'Chinese ä¸­æ–‡';
            }
            
            updateVocabLinkLanguage();
            updateDownloadSectionLanguage();
            updateUI();
        }

        // --- Main UI Update Function ---
        function updateUI() {
            const bookData = getBookData();
            const totalTextPages = Object.keys(bookData).filter(key => !isNaN(parseInt(key))).length;
            
            if (currentPage > totalTextPages) {
                currentPage = totalTextPages;
            }

            const isCoverPage = currentPage === -1;
            const isEndPage = currentPage === totalTextPages;

            const titleElement = document.getElementById('title');
            const authorElement = document.getElementById('author');
            const imageElement = document.getElementById('book-image');
            const contentElement = document.getElementById('book-content');
            const pageNumberElement = document.getElementById('page-number');
            const downloadsContainer = document.getElementById('downloads-container');

            let imagePath, content, pageText;

            // Determine Content and Metadata
            if (isCoverPage) {
                imagePath = `images/${bookData.cover || 'cover.png'}`; 
                content = bookData.cover_text || '';
                pageText = '';
            } else if (isEndPage) {
                imagePath = `images/${bookData.end_image || 'end.png'}`; 
                content = bookData.end || '';
                pageText = currentLang === 'en' ? 'End Page' : 'ç»“æŸé¡µ';
            } else {
                const pageKey = (currentPage + 1).toString();
                imagePath = `images/${pageKey}.png`;
                content = bookData[pageKey] || '';
                pageText = `${currentLang === 'en' ? 'Page' : 'é¡µ'} ${pageKey} ${currentLang === 'en' ? 'of' : 'å…±'} ${totalTextPages}`;
            }
            
            // Update DOM Elements
            titleElement.style.display = isCoverPage ? 'block' : 'none';
            authorElement.style.display = isCoverPage ? 'block' : 'none';

            titleElement.textContent = bookData.title;
            authorElement.textContent = bookData.author;
            imageElement.src = imagePath;
            contentElement.textContent = content;
            pageNumberElement.textContent = pageText;
            
            updateVocabLinkVisibility(totalTextPages);
            
            // Speech Logic
            let speechText;
            if (isCoverPage) {
                speechText = `${bookData.title}. By ${bookData.author}. ${content}`;
            } else {
                speechText = content;
            }
            
            stopSpeaking();
            speakContent(speechText);
        }

        function changePage(direction) {
            const bookData = getBookData();
            const totalTextPages = Object.keys(bookData).filter(key => !isNaN(parseInt(key))).length;
            let newPage = currentPage + direction;

            if (direction === 1) { 
                if (newPage > totalTextPages) {
                    newPage = -1; 
                }
            } else if (direction === -1) { 
                if (newPage < -1) {
                    return;
                }
            }
            
            if (newPage >= -1 && newPage <= totalTextPages) {
                currentPage = newPage;
                updateUI();
            }
        }

        // --- Event Handlers and Initial Setup ---
        document.addEventListener('DOMContentLoaded', () => {
            const langToggleButton = document.getElementById('lang-toggle');
            
            langToggleButton.textContent = 'Chinese ä¸­æ–‡'; 

            langToggleButton.addEventListener('click', (event) => {
                event.stopPropagation();
                toggleLanguage();
            });
            
            document.body.addEventListener('click', (event) => {
                if (event.target.id === 'lang-toggle' || event.target.closest('#vocab-link-container') || event.target.closest('#downloads-container')) return;

                const isRightSide = event.clientX > window.innerWidth / 2;
                if (isRightSide) {
                    changePage(1);
                } else {
                    if (currentPage > -1) {
                        changePage(-1);
                    }
                }
            });

            document.body.addEventListener('keyup', (event) => {
                const isNextKey = event.key === 'Enter' || event.keyCode === 13 || event.key === 'ArrowRight' || event.keyCode === 39;
                const isPreviousKey = event.key === 'ArrowLeft' || event.keyCode === 37;

                if (isNextKey) {
                    changePage(1);
                } else if (isPreviousKey) {
                    if (currentPage > -1) {
                        changePage(-1);
                    }
                }
            });
            
            // Initial setup
            updateUI(); 
            updateVocabLinkLanguage();
            updateDownloadSectionLanguage();
            checkAudioFiles(); // Check for audio files on load
        });
    </script>
</body>
</html>